<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />

        <!-- RPD: css -->
        <link rel="stylesheet" href="./rpd.css"></link>
        <!-- Toolkit: jb (svg) -->
        <link rel="stylesheet" href="./toolkit/jb/svg.css"></link>

        <!-- Kefir.js library -->
        <script src="./kefir.min.js"></script>

        <!-- RPD Library (http://shamansir.github.io/rpd) -->
        <script src="./rpd.min.js"></script>

        <!-- Toolkit: jb, utils -->
        <script src="./toolkit/jb/shared.js"></script>
        <!-- Toolkit: jb -->
        <script src="./toolkit/jb/toolkit.js"></script>
        <!-- Toolkit: jb (svg) -->
        <script src="./toolkit/jb/svg.js"></script>

        <!-- p5.js -->
        <script src="./p5.min.js"></script>
        <script src="./p5.dom.js"></script>

        <!-- d3.voronoi.js -->
        <!-- <script src="./d3-voronoi.v1.min.js"></script> -->

        <style>
            body {
                margin: 0;
                padding: 0;
            }

            #overlay {
                background-color: rgba(0,0,0,0.5);
                opacity: 1;
                transition: opacity 500ms ease-in;
            }

            #overlay.hidden {
                opacity: 0;
            }

            #patch-target {
                opacity: 1;
                transition: opacity 500ms ease-in;
            }

            #patch-target.hidden {
                opacity: 0;
            }

            #patch-target .rpd-background {
                /* fill: transparent; */
                opacity: 0.3;
            }

            #rpd-jb-preview-target {
                position: fixed;
            }

            #rpd-jb-preview-target,
            #rpd-jb-preview-target canvas {
                background: #12181C;
            }

            #front-layer {
                position: relative;
            }

            .rpd-node .rpd-content {
                opacity: 0.85;
            }
        </style>

    </head>
    <body>

        <div id="rpd-jb-preview-target"></div>
        <div id="front-layer">
            <div id="overlay"></div>
            <div id="patch-target"></div>
        </div>

        <script>
            // window.___sketchUpdateProxy = function(config) {
            window.updateSketchConfig = function(config) {
                window.missedSketchConfig = config;
            }; // sketch will replace it later
        </script>

        <script>

            // ============= Register p5/sketch node type and renderer =============

            /* var SVG_XMLNS = "http://www.w3.org/2000/svg";

            Rpd.noderenderer('p5/sketch', 'svg', {
                size: { width: 420, height: 320 },
                pivot: { x: 0, y: 0 },
                first: function(bodyElm) {
                    var group = document.createElementNS(SVG_XMLNS, 'g');
                    group.setAttributeNS(null, 'transform', 'translate(10, 10)');
                    var foreign = document.createElementNS(SVG_XMLNS, 'foreignObject');
                    var p5Target = document.createElement('div');
                    p5Target.id = 'p5-canvas';
                    foreign.appendChild(p5Target);
                    group.appendChild(foreign);
                    bodyElm.appendChild(group);
                }
            }); */

            // ============= Build and render patch =============

            var patch = Rpd.addPatch('jb-sketch');

            patch.render('svg', document.getElementById('patch-target'),
                         { style: 'ableton-out',
                           fullPage: true,
                           linkForm: 'curve' });

            patch.addNode('util/nodelist').move(800, 50);

            patch.addNode('jb/config').move(200, 200);

            var previewTarget = document.getElementById('rpd-jb-preview-target');
            previewTarget.style.width = window.innerWidth + 'px';
            previewTarget.style.height = window.innerHeight + 'px';

            Kefir.fromEvents(document.body, 'keydown').filter(function(evt) {
                return evt.keyCode === 32;
            }).onValue(function(evt) {
                evt.preventDefault();
            });

            var overlayElm = document.getElementById('overlay');
            var patchElm = document.getElementById('patch-target');
            Kefir.fromEvents(document.body, 'keydown').filter(function(evt) {
                return evt.keyCode === 32;
            }).scan(function(prev, next) {
                return !prev;
            }, true).onValue(function(value) {
                overlayElm.className = value ? 'visible' : 'hidden';
                patchElm.className = value ? 'visible' : 'hidden';
            });

            patch.addNode('jb/preview').move(800, 400);

        </script>

        <!-- p5.js -->
        <script src="./p5.min.js"></script>
        <!-- <script src="./p5.dom.js"></script> -->
        <!-- p5 Sketch -->
        <script src="./sketch.p5.js"></script>

        <script>
            window.addEventListener('load', function() {
                /* window.___sketchUpdateProxy = function(config) {
                    // uses a global function from the sketch
                    updateSketchConfig(config);
                }; */

                //if (window.missedSketchConfig) window.___sketchUpdateProxy(window.missedSketchConfig);
                if (window.missedSketchConfig) window.updateSketchConfig(window.missedSketchConfig);
            });
        </script>

    </body>
</html>
